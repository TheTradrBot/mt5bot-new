# Self-Optimizing MT5 Bot Backtest System - November FTMO Challenge

## Objective
Create an automated backtesting and optimization system that:  
1. Backtests the main_live_bot for November 2024
2. Validates if it passes **BOTH Phase 1 AND Phase 2** of at least 1 complete FTMO challenge
3. If it fails either phase, automatically optimizes the bot parameters
4. Repeats the backtest-optimize cycle until BOTH phases are passed
5. Cleans up all unnecessary files and old backtest results from the repository

## FTMO Challenge Criteria to Meet (BOTH PHASES REQUIRED)

### Phase 1 Requirements (MUST PASS): 
- **Profit Target**: 10% of initial balance ($1,000 profit on $10,000)
- **Maximum Daily Loss**: 5% of initial balance ($500 max loss per day)
- **Maximum Loss**:  10% of initial balance ($1,000 total drawdown limit)
- **Minimum Trading Days**:  4 days
- **Trading Period**: 30 days (unlimited for our backtest)

### Phase 2 Requirements (MUST ALSO PASS):
- **Profit Target**: 5% of Phase 1 ending balance ($550 profit on $11,000)
- **Maximum Daily Loss**:  5% of Phase 1 ending balance ($550 max loss per day)
- **Maximum Loss**:  10% of Phase 1 ending balance ($1,100 total drawdown limit)
- **Minimum Trading Days**: 4 days
- **Trading Period**:  60 days (unlimited for our backtest)

**SUCCESS = Passing BOTH Phase 1 AND Phase 2 in the same backtest run**
**INITIAL BALANCE = $10,000**

## Implementation Steps

### 1. Repository Cleanup
Before starting, clean up the repository:  
- Delete all old backtest files from `main_live_bot/` directory
- Remove any `.pyc` files, `__pycache__` directories
- Remove any temporary files, logs that are not needed
- Remove old configuration backups
- Keep only essential bot files, configuration files, and core logic

### 2. Backtest System Setup
Create a robust backtesting framework:
- Load historical data for November 2024 (entire month)
- Simulate the main_live_bot trading strategy
- **Starting balance:  $10,000**
- Track all trades, equity curve, drawdown, daily P&L
- Calculate all FTMO metrics in real-time
- **Split the backtest into two phases sequentially**: 
  - Phase 1: First portion of November until 10% profit target hit ($11,000 balance)
  - Phase 2: Continue from Phase 1 ending balance (~$11,000) until 5% profit target hit (~$11,550)

### 3. FTMO Two-Phase Validation Logic
Implement a validator that checks BOTH phases:
```python
def validate_ftmo_complete_challenge(backtest_results):
    """
    Validates that the bot passes BOTH Phase 1 AND Phase 2
    Starting balance: $10,000
    Returns:  (passed, phase_results)
    """
    initial_balance = 10000  # FTMO starting balance
    
    # ============ PHASE 1 VALIDATION ============
    phase1_data = backtest_results['phase1']
    phase1_end_balance = phase1_data['final_balance']
    
    phase1_profit = phase1_end_balance - initial_balance
    phase1_profit_pct = (phase1_profit / initial_balance) * 100
    phase1_max_daily_loss = abs(min(phase1_data['daily_pnl']))
    phase1_max_daily_loss_pct = (phase1_max_daily_loss / initial_balance) * 100
    phase1_max_drawdown = abs(phase1_data['max_drawdown'])
    phase1_max_drawdown_pct = (phase1_max_drawdown / initial_balance) * 100
    phase1_trading_days = phase1_data['active_trading_days']
    
    phase1_passed = (
        phase1_profit >= 1000 and  # $1,000 profit (10%)
        phase1_max_daily_loss <= 500 and  # Max $500 daily loss (5%)
        phase1_max_drawdown <= 1000 and  # Max $1,000 total loss (10%)
        phase1_trading_days >= 4
    )
    
    print(f"\n{'='*70}")
    print(f"üìä PHASE 1 RESULTS (Starting Balance: ${initial_balance:,. 2f})")
    print(f"{'='*70}")
    print(f"   Ending Balance: ${phase1_end_balance:,.2f}")
    print(f"   Profit:  ${phase1_profit:,.2f} ({phase1_profit_pct:.2f}%) - Target: $1,000 (10%) {'‚úÖ' if phase1_profit >= 1000 else '‚ùå'}")
    print(f"   Max Daily Loss: ${phase1_max_daily_loss: ,.2f} ({phase1_max_daily_loss_pct:.2f}%) - Limit: $500 (5%) {'‚úÖ' if phase1_max_daily_loss <= 500 else '‚ùå'}")
    print(f"   Max Drawdown: ${phase1_max_drawdown:,.2f} ({phase1_max_drawdown_pct:.2f}%) - Limit: $1,000 (10%) {'‚úÖ' if phase1_max_drawdown <= 1000 else '‚ùå'}")
    print(f"   Trading Days: {phase1_trading_days} - Minimum: 4 {'‚úÖ' if phase1_trading_days >= 4 else '‚ùå'}")
    print(f"   Win Rate: {phase1_data. get('win_rate', 0):.1f}%")
    print(f"   Total Trades: {phase1_data.get('total_trades', 0)}")
    print(f"   STATUS: {'‚úÖ PASSED' if phase1_passed else '‚ùå FAILED'}")
    print(f"{'='*70}")
    
    if not phase1_passed:
        return False, {'phase1': phase1_passed, 'phase2': False}
    
    # ============ PHASE 2 VALIDATION ============
    phase2_data = backtest_results['phase2']
    phase2_start_balance = phase1_end_balance
    phase2_end_balance = phase2_data['final_balance']
    
    phase2_profit = phase2_end_balance - phase2_start_balance
    phase2_profit_pct = (phase2_profit / phase2_start_balance) * 100
    phase2_profit_target = phase2_start_balance * 0.05  # 5% of starting balance
    phase2_max_daily_loss = abs(min(phase2_data['daily_pnl']))
    phase2_max_daily_loss_pct = (phase2_max_daily_loss / phase2_start_balance) * 100
    phase2_daily_loss_limit = phase2_start_balance * 0.05  # 5% of starting balance
    phase2_max_drawdown = abs(phase2_data['max_drawdown'])
    phase2_max_drawdown_pct = (phase2_max_drawdown / phase2_start_balance) * 100
    phase2_drawdown_limit = phase2_start_balance * 0.10  # 10% of starting balance
    phase2_trading_days = phase2_data['active_trading_days']
    
    phase2_passed = (
        phase2_profit >= phase2_profit_target and  # 5% profit
        phase2_max_daily_loss <= phase2_daily_loss_limit and  # Max 5% daily loss
        phase2_max_drawdown <= phase2_drawdown_limit and  # Max 10% total loss
        phase2_trading_days >= 4
    )
    
    print(f"\n{'='*70}")
    print(f"üìä PHASE 2 RESULTS (Starting Balance: ${phase2_start_balance:,.2f})")
    print(f"{'='*70}")
    print(f"   Ending Balance: ${phase2_end_balance:,.2f}")
    print(f"   Profit: ${phase2_profit:,.2f} ({phase2_profit_pct:.2f}%) - Target: ${phase2_profit_target:,. 2f} (5%) {'‚úÖ' if phase2_profit >= phase2_profit_target else '‚ùå'}")
    print(f"   Max Daily Loss: ${phase2_max_daily_loss:,.2f} ({phase2_max_daily_loss_pct:.2f}%) - Limit: ${phase2_daily_loss_limit:,.2f} (5%) {'‚úÖ' if phase2_max_daily_loss <= phase2_daily_loss_limit else '‚ùå'}")
    print(f"   Max Drawdown: ${phase2_max_drawdown:,.2f} ({phase2_max_drawdown_pct:.2f}%) - Limit: ${phase2_drawdown_limit:,. 2f} (10%) {'‚úÖ' if phase2_max_drawdown <= phase2_drawdown_limit else '‚ùå'}")
    print(f"   Trading Days: {phase2_trading_days} - Minimum: 4 {'‚úÖ' if phase2_trading_days >= 4 else '‚ùå'}")
    print(f"   Win Rate:  {phase2_data.get('win_rate', 0):.1f}%")
    print(f"   Total Trades:  {phase2_data.get('total_trades', 0)}")
    print(f"   STATUS: {'‚úÖ PASSED' if phase2_passed else '‚ùå FAILED'}")
    print(f"{'='*70}")
    
    complete_challenge_passed = phase1_passed and phase2_passed
    
    return complete_challenge_passed, {'phase1': phase1_passed, 'phase2': phase2_passed}
```

### 4. Optimization Engine
Create an intelligent optimizer that:
- Identifies which parameters to optimize (lot size, stop loss, take profit, indicators, etc.)
- Uses techniques like:
  - Grid search for discrete parameters
  - Bayesian optimization for continuous parameters
  - Genetic algorithms for complex parameter spaces
- Focuses on parameters that improve:   
  - Win rate consistency (important for both phases)
  - Risk-reward ratio
  - Drawdown control (critical - can't exceed $1,000 in Phase 1, ~$1,100 in Phase 2)
  - Daily loss limits (critical - can't exceed $500 in Phase 1, ~$550 in Phase 2)
  - Profit consistency (need sustained performance)

Key parameters to optimize:
- Risk per trade (lot sizing) - **MOST CRITICAL** (on $10k account, risk management is crucial)
- Stop loss levels
- Take profit levels
- Entry/exit indicator thresholds
- Trading session filters
- Maximum daily trades (to avoid exceeding daily loss)
- Trailing stop settings
- Profit protection mechanisms

### 5. Main Optimization Loop
```python
max_iterations = 100  # Prevent infinite loops
iteration = 0
complete_challenge_passed = False

INITIAL_BALANCE = 10000  # FTMO 10K account

while not complete_challenge_passed and iteration < max_iterations:  
    print(f"\n{'='*70}")
    print(f"üîÑ ITERATION {iteration + 1}:   Running November FTMO Challenge Backtest")
    print(f"   Starting Balance: ${INITIAL_BALANCE:,.2f}")
    print(f"{'='*70}\n")
    
    # Run complete backtest (both phases)
    backtest_results = run_complete_ftmo_backtest_november(
        main_live_bot_config, 
        initial_balance=INITIAL_BALANCE
    )
    
    # Display results
    display_backtest_summary(backtest_results)
    
    # Validate BOTH phases
    complete_challenge_passed, phase_results = validate_ftmo_complete_challenge(backtest_results)
    
    if complete_challenge_passed:
        total_profit = backtest_results['phase2']['final_balance'] - INITIAL_BALANCE
        total_profit_pct = (total_profit / INITIAL_BALANCE) * 100
        
        print("\n" + "="*70)
        print("üéâüéâüéâ SUCCESS! Bot passed COMPLETE FTMO CHALLENGE! üéâüéâüéâ")
        print("="*70)
        print("‚úÖ Phase 1: PASSED")
        print("‚úÖ Phase 2: PASSED")
        print(f"üí∞ Total Profit: ${total_profit: ,.2f} ({total_profit_pct:.2f}%)")
        print(f"üíµ Final Balance: ${backtest_results['phase2']['final_balance']:,. 2f}")
        print("="*70)
        save_winning_configuration(main_live_bot_config, backtest_results)
        generate_final_report(backtest_results, iteration + 1)
        break
    else:
        print("\n" + "="*70)
        print("‚ùå FTMO COMPLETE CHALLENGE NOT PASSED")
        if not phase_results['phase1']:
            print("‚ùå Phase 1:  FAILED - Bot didn't meet Phase 1 criteria")
        else:
            print("‚úÖ Phase 1: PASSED")
            print("‚ùå Phase 2: FAILED - Bot didn't meet Phase 2 criteria")
        print("üîß Optimizing parameters based on failure analysis...")
        print("="*70)
        
        # Analyze failure reasons
        failure_analysis = analyze_failure(backtest_results, phase_results)
        
        # Optimize based on failure analysis
        main_live_bot_config = optimize_parameters(
            current_config=main_live_bot_config,
            backtest_results=backtest_results,
            failure_reasons=failure_analysis,
            failed_phase=1 if not phase_results['phase1'] else 2
        )
        
        iteration += 1
        
        # Save iteration data
        save_iteration_results(iteration, backtest_results, main_live_bot_config)

if not complete_challenge_passed:  
    print("\n‚ö†Ô∏è Maximum iterations reached. Best configuration saved.")
    save_best_attempt(main_live_bot_config, backtest_results)
```

### 6. Reporting System
Generate comprehensive reports after each iteration:  
- **Two-Phase Equity Curve**: Visual graph showing balance over time with phase separation
- **Drawdown Chart**: Daily and maximum drawdown for both phases
- **Trade Log**: All trades with entry/exit points, P&L for both phases
- **FTMO Metrics Dashboard**: Clear display of all criteria for both phases (in dollar amounts AND percentages)
- **Optimization History**: Show improvement across iterations
- **Final Configuration**: Export winning parameters to config file

### 7. Output Structure
Save all outputs to a `november_ftmo_backtest/` directory:
```
november_ftmo_backtest/
‚îú‚îÄ‚îÄ iteration_1/
‚îÇ   ‚îú‚îÄ‚îÄ backtest_results.json
‚îÇ   ‚îú‚îÄ‚îÄ phase1_equity_curve.png
‚îÇ   ‚îú‚îÄ‚îÄ phase2_equity_curve.png
‚îÇ   ‚îú‚îÄ‚îÄ combined_equity_curve.png
‚îÇ   ‚îú‚îÄ‚îÄ trade_log_phase1.csv
‚îÇ   ‚îú‚îÄ‚îÄ trade_log_phase2.csv
‚îÇ   ‚îî‚îÄ‚îÄ ftmo_metrics.txt
‚îú‚îÄ‚îÄ iteration_2/
‚îÇ   ‚îî‚îÄ‚îÄ ...  
‚îú‚îÄ‚îÄ winning_configuration/
‚îÇ   ‚îú‚îÄ‚îÄ optimized_config.json
‚îÇ   ‚îú‚îÄ‚îÄ final_equity_curve_both_phases.png
‚îÇ   ‚îú‚îÄ‚îÄ final_trade_log_complete.csv
‚îÇ   ‚îú‚îÄ‚îÄ phase1_detailed_report.pdf
‚îÇ   ‚îú‚îÄ‚îÄ phase2_detailed_report.pdf
‚îÇ   ‚îî‚îÄ‚îÄ ftmo_complete_challenge_certification. pdf
‚îî‚îÄ‚îÄ optimization_summary.txt
```

## Key Features to Implement

1. **Sequential Phase Testing**: Run Phase 1 first, only continue to Phase 2 if Phase 1 passes
2. **Real-time Progress Tracking**: Show live updates during backtest for both phases
3. **Intelligent Parameter Adjustment**: Learn from which phase failed and why
4. **Risk Management Focus**: Prioritize drawdown control and daily loss limits for BOTH phases
5. **Multi-metric Optimization**: Balance profit with risk metrics across both phases
6. **Validation Against Overfitting**: Ensure optimized parameters work for both phases
7. **Automated File Cleanup**: Remove all unnecessary files before starting
8. **Configuration Backup**: Save each iteration's config for rollback if needed
9. **Phase-Specific Optimization**: If Phase 1 fails, focus on aggressive profit.  If Phase 2 fails, focus on consistency
10. **$10K Account Specific**: Optimize lot sizes appropriate for $10,000 account

## Success Criteria

The system should output:
```
‚úÖ‚úÖ November Backtest PASSED COMPLETE FTMO CHALLENGE!  ‚úÖ‚úÖ

üìä PHASE 1 RESULTS (PASSED):
- Starting Balance: $10,000.00
- Ending Balance: $11,250.00
- Profit: $1,250.00 (12.5%) - Target: $1,000 (10%) ‚úÖ
- Max Daily Loss: $320.00 (3.2%) - Limit: $500 (5%) ‚úÖ
- Max Drawdown: $680.00 (6.8%) - Limit: $1,000 (10%) ‚úÖ
- Trading Days: 8 days - Minimum: 4 ‚úÖ
- Win Rate: 68%
- Profit Factor: 2.3
- Total Trades: 27
- Duration: 14 days

üìä PHASE 2 RESULTS (PASSED):
- Starting Balance: $11,250.00
- Ending Balance: $12,060.00
- Profit: $810.00 (7.2%) - Target: $562.50 (5%) ‚úÖ
- Max Daily Loss: $315.00 (2.8%) - Limit: $562.50 (5%) ‚úÖ
- Max Drawdown:  $607.50 (5.4%) - Limit: $1,125. 00 (10%) ‚úÖ
- Trading Days: 6 days - Minimum: 4 ‚úÖ
- Win Rate:  71%
- Profit Factor: 2.6
- Total Trades: 20
- Duration: 12 days

üí∞ OVERALL CHALLENGE RESULTS:
- Starting Balance: $10,000.00
- Final Balance: $12,060.00
- Total Profit: $2,060.00 (20.6%)
- Combined Win Rate: 69.5%
- Total Trades: 47
- Total Duration: 26 days

üîß Optimizations Applied:  5 iterations
‚è±Ô∏è Total Runtime: 23 minutes

üíæ Winning configuration saved to: winning_configuration/optimized_config.json
üìÑ Full certification report: winning_configuration/ftmo_complete_challenge_certification.pdf
```

## Additional Instructions

- Use proper error handling for MT5 connection issues
- Implement logging for debugging
- Make the code modular and reusable
- Add comments explaining optimization decisions
- Create visualization charts for better analysis
- **Test with initial balance of $10,000** (FTMO 10K account)
- Use November 2024 data (or most recent November available)
- **Clearly separate Phase 1 and Phase 2 in all reports**
- **Track daily losses separately for each phase** (critical for validation)
- **Ensure optimization doesn't overfit to just one phase**
- **Display all dollar amounts with 2 decimal places**
- **Show both dollar amounts AND percentages for all metrics**

## Performance Guidelines

- Each complete backtest (both phases) should complete in < 5 minutes
- Optimization cycle should show measurable improvement
- System should be fault-tolerant and resume-capable
- All file operations should be safe and atomic
- Prioritize not breaking daily loss limits over maximizing profit

## Optimization Strategy Hints

- **If failing Phase 1**:  Increase risk slightly to hit $1,000 target faster, but watch daily $500 limit
- **If failing Phase 2**: Decrease risk, focus on consistency and capital preservation
- **If failing daily loss limits in either phase**: Reduce lot sizes (crucial on $10K account), add stricter stop losses, limit trades per day
- **If failing drawdown limits**: Implement better trailing stops, partial profit taking
- **Lot sizing for $10K account**: Start conservative (0.01-0.10 lots depending on pair), scale carefully

Start by cleaning the repository, then build the two-phase backtest system, implement FTMO validation for BOTH phases with $10,000 starting balance, create the optimization loop, and iterate until BOTH phases pass!  üöÄüöÄ